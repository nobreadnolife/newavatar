<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NJZ头像生成器</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* 自定义字体定义 */
        @font-face {
            font-family: 'YaheiHeavy';
            src: url('yaheiheavy.woff2') format('woff2'),
                 url('yaheiheavy.woff') format('woff'),
                 url('yaheiheavy.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* Reset some default styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-image: url('dreamscape-bg.jpg'); /* 梦幻星空背景图片 */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff; /* 更改文字颜色为白色以便在深色背景上更易读 */
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); /* 添加文字阴影增加可读性 */
            text-align: center;
            padding: 20px;
        }

        .instructions {
            margin: 15px auto;
            max-width: 600px;
            text-align: left;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333; /* 深色文字在浅色背景上 */
            text-shadow: none; /* 移除文字阴影 */
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }

        #upload {
            font-size: 1rem;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #upload:hover {
            background-color: #45a049;
        }

        #canvas-container {
            position: relative;
            display: inline-block;
            touch-action: none;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin-top: 20px;
            background-color: transparent;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        canvas {
            max-width: 100%;
            max-height: 80vh;
            touch-action: none;
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            border-radius: 8px;
        }

        #generate-btn {
            margin-top: 20px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #8a2be2, #4169e1); /* 紫蓝渐变色调 */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(65, 105, 225, 0.5);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        #generate-btn:hover {
            background: linear-gradient(135deg, #9b4dff, #567df4);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(65, 105, 225, 0.6);
        }
        
        #generate-btn:disabled {
            background: linear-gradient(135deg, #a9a9a9, #d3d3d3);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* 上传框 */
        input[type="file"] {
            display: none;
        }

        label[for="upload"] {
            cursor: pointer;
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #9932cc, #8a2be2); /* 紫色渐变 */
            color: white;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.5);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        label[for="upload"]:hover {
            background: linear-gradient(135deg, #a64dff, #9b4dff);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(138, 43, 226, 0.6);
        }
    </style>
</head>
<body>
    <h2 style="font-size: 2.5rem; margin-bottom: 25px; color: #FFFFFF; font-family: 'YaheiHeavy', 'Microsoft YaHei', sans-serif; font-weight: bold; -webkit-text-stroke: 9px #7575AB; text-stroke: 9px #7575AB;">NJZ头像生成器</h2>
    
    <div class="instructions">
        <h3>使用说明：</h3>
        <ul>
            <li>上传<strong>透明背景</strong>的<strong>PNG</strong>图片（如有魔法可尝试用<a href="https://www.remove.bg/zh/upload" target="_blank">链接</a>扣图）</li>
            <li>拖拽图片调整位置</li>
            <li>使用鼠标滚轮或双指缩放调整大小</li>
            <li>点击"生成头像"按钮查看并保存</li>
        </ul>
    </div>
    
    <!-- 文件上传 -->
    <label for="upload">选择透明PNG图片</label>
    <input type="file" id="upload" accept="image/png">
    <br><br>

    <!-- Canvas区域 -->
    <div id="canvas-container">
        <canvas id="canvas"></canvas>
    </div>

    <br>
    <!-- 生成按钮 -->
    <button id="generate-btn" disabled>生成头像</button>

    <!-- 隐藏的输出Canvas -->
    <canvas id="output-canvas" style="display: none;"></canvas>

    <script>
        const uploadInput = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const generateBtn = document.getElementById('generate-btn');
        const outputCanvas = document.getElementById('output-canvas');
        const outputCtx = outputCanvas.getContext('2d');
        
        let imageObj = new Image(); // 用户上传的图片
        let bgImage = new Image(); // 背景图
        let scale = 1.0, imgX = 0, imgY = 0; // 变量定义
        let isDragging = false, lastTouchDist = 0;
        let startX, startY;

        // 设置Canvas大小（这里假设背景图为正方形）
        canvas.width = 500; 
        canvas.height = 500;
        
        // 设置输出Canvas大小（更高分辨率）
        const outputSize = 1200;
        outputCanvas.width = outputSize;
        outputCanvas.height = outputSize;
        
        // 加载背景图片
        bgImage.src = "bg.jpeg";
        bgImage.onload = () => {
            drawCanvas();
        };
        bgImage.onerror = () => {
            console.error("背景图加载失败");
            alert("背景图加载失败，请检查图片路径是否正确");
        };

        // 上传图片处理
        uploadInput.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;
            
            // 仅接受PNG图片
            if (!file.type.match('image/png')) {
                alert("请上传PNG格式的图片！");
                return;
            }
            
            // 读取用户上传的图片
            const reader = new FileReader();
            reader.onload = function(e) {
                imageObj = new Image();
                imageObj.src = e.target.result;
                
                imageObj.onload = () => {
                    // 计算初始位置（居中）
                    imgX = (canvas.width - imageObj.width) / 2;
                    imgY = (canvas.height - imageObj.height) / 2;
                    scale = 1.0;
                    drawCanvas();
                    generateBtn.disabled = false;
                };
                
                imageObj.onerror = () => {
                    alert("图片加载失败，请检查图片格式");
                };
            };
            
            reader.onerror = function() {
                alert("读取文件时出错");
            };
            
            reader.readAsDataURL(file);
        });

        // 画布绘制函数
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            if (bgImage.complete && bgImage.naturalWidth > 0) {
                ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
            }
            
            // 绘制用户上传的图片
            if (imageObj.complete && imageObj.naturalWidth > 0) { 
                ctx.drawImage(
                    imageObj, 
                    imgX, 
                    imgY, 
                    imageObj.width * scale, 
                    imageObj.height * scale
                );
            }
        }

        // 鼠标事件 - 拖拽
        canvas.addEventListener("mousedown", (e) => {
            if (imageObj.complete && imageObj.naturalWidth > 0) {
                isDragging = true;
                startX = e.clientX - imgX;
                startY = e.clientY - imgY;
                e.preventDefault();
            }
        });

        canvas.addEventListener("mousemove", (e) => {
            if (isDragging) {
                imgX = e.clientX - startX;
                imgY = e.clientY - startY;
                drawCanvas();
                e.preventDefault();
            }
        });

        canvas.addEventListener("mouseup", (e) => {
            isDragging = false;
            e.preventDefault();
        });
        
        canvas.addEventListener("mouseleave", (e) => {
            isDragging = false;
            e.preventDefault();
        });
        
        // 鼠标滚轮缩放
        canvas.addEventListener("wheel", (e) => {
            if (imageObj.complete && imageObj.naturalWidth > 0) {
                e.preventDefault();
                
                // 获取鼠标位置相对于图片的坐标
                const mouseX = e.clientX - canvas.getBoundingClientRect().left;
                const mouseY = e.clientY - canvas.getBoundingClientRect().top;
                
                // 计算鼠标相对于图片的偏移
                const x = mouseX - imgX;
                const y = mouseY - imgY;
                
                // 根据滚轮方向确定缩放方向
                const delta = e.deltaY < 0 ? 1.1 : 0.9;
                
                // 应用缩放
                scale *= delta;
                
                // 限制最小和最大缩放
                scale = Math.max(0.1, Math.min(5, scale));
                
                // 调整位置，使鼠标下的点保持不变
                imgX = mouseX - x * delta;
                imgY = mouseY - y * delta;
                
                drawCanvas();
            }
        });

        // 触摸事件 - 拖拽
        canvas.addEventListener("touchstart", (e) => {
            if (imageObj.complete && imageObj.naturalWidth > 0) {
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - imgX;
                    startY = e.touches[0].clientY - imgY;
                } else if (e.touches.length === 2) {
                    // 记录两个触摸点的距离，用于缩放
                    lastTouchDist = getTouchDistance(e.touches);
                }
                e.preventDefault();
            }
        });

        canvas.addEventListener("touchmove", (e) => {
            if (imageObj.complete && imageObj.naturalWidth > 0) {
                e.preventDefault();
                
                if (isDragging && e.touches.length === 1) {
                    // 单指拖动
                    imgX = e.touches[0].clientX - startX;
                    imgY = e.touches[0].clientY - startY;
                    drawCanvas();
                } else if (e.touches.length === 2) {
                    // 双指缩放
                    const newDist = getTouchDistance(e.touches);
                    const delta = newDist / lastTouchDist;
                    
                    // 计算双指中心点
                    const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - canvas.getBoundingClientRect().left;
                    const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - canvas.getBoundingClientRect().top;
                    
                    // 计算中心点相对于图片的偏移
                    const x = centerX - imgX;
                    const y = centerY - imgY;
                    
                    // 应用缩放
                    scale *= delta;
                    
                    // 限制最小和最大缩放
                    scale = Math.max(0.1, Math.min(5, scale));
                    
                    // 调整位置，使中心点保持不变
                    imgX = centerX - x * delta;
                    imgY = centerY - y * delta;
                    
                    lastTouchDist = newDist;
                    drawCanvas();
                }
            }
        });

        canvas.addEventListener("touchend", (e) => {
            isDragging = false;
            if (e.touches.length < 2) {
                // 如果少于两个触摸点，取消缩放状态
                lastTouchDist = 0;
            }
            e.preventDefault();
        });

        // 计算两个触摸点之间的距离
        function getTouchDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // 生成高质量头像并在新窗口中显示
        generateBtn.addEventListener("click", function () {
            if (!imageObj.complete || imageObj.naturalWidth === 0) {
                alert("请先上传PNG图片！");
                return;
            }
            
            // 在高分辨率画布上重新绘制
            outputCtx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            
            // 绘制背景（缩放到高分辨率）
            if (bgImage.complete && bgImage.naturalWidth > 0) {
                outputCtx.drawImage(bgImage, 0, 0, outputCanvas.width, outputCanvas.height);
            }
            
            // 计算缩放比例
            const scaleFactor = outputSize / canvas.width;
            
            // 绘制用户上传的图片（缩放到高分辨率）
            if (imageObj.complete && imageObj.naturalWidth > 0) { 
                outputCtx.drawImage(
                    imageObj, 
                    imgX * scaleFactor, 
                    imgY * scaleFactor, 
                    imageObj.width * scale * scaleFactor, 
                    imageObj.height * scale * scaleFactor
                );
            }
            
            // 获取图像数据并打开新窗口
            const dataUrl = outputCanvas.toDataURL("image/png");
            
            // 打开新窗口并显示结果
            const newWindow = window.open();
            newWindow.document.write(`
                <!DOCTYPE html>
                <html lang="zh">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>NJZ头像</title>
                    <link rel="icon" href="favicon.ico" type="image/x-icon">
                    <style>
                        @font-face {
                            font-family: 'YaheiHeavy';
                            src: url('yaheiheavy.woff2') format('woff2'),
                                 url('yaheiheavy.woff') format('woff'),
                                 url('yaheiheavy.ttf') format('truetype');
                            font-weight: normal;
                            font-style: normal;
                        }
                    
                        body {
                            font-family: 'Arial', sans-serif;
                            background-image: url('dreamscape-bg.jpg'); /* 新页面也使用相同背景 */
                            background-size: cover;
                            background-position: center;
                            background-attachment: fixed;
                            margin: 0;
                            padding: 20px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                            text-align: center;
                        }
                        .avatar-container {
                            background-color: rgba(255, 255, 255, 0.85);
                            padding: 25px;
                            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
                            max-width: 100%;
                            border-radius: 15px;
                            backdrop-filter: blur(8px);
                            -webkit-backdrop-filter: blur(8px);
                            margin: 20px;
                        }
                        img {
                            max-width: 100%;
                            height: auto;
                            margin-bottom: 20px;
                            border-radius: 5px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        p {
                            color: #333;
                            margin-bottom: 20px;
                            font-size: 18px;
                            font-weight: bold;
                            font-family: 'YaheiHeavy', 'Microsoft YaHei', sans-serif;
                        }
                    </style>
                </head>
                <body>
                    <div class="avatar-container">
                        <img src="${dataUrl}" alt="Generated Avatar">
                        <p>长按图片保存头像</p>
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        });
    </script>
</body>
</html>